# Isaac ROS Configuration for Humanoid Robot AI Pipeline
# This configuration demonstrates Isaac-specific settings for perception, navigation, and learning

# Isaac Perception Pipeline Configuration
perception_pipeline:
  stereo_rectification:
    enabled: true
    calibration_file: "/path/to/stereo_calibration.yaml"

  visual_slam:
    package: "isaac_ros_visual_slam"
    parameters:
      enable_rectification: true
      map_frame: "map"
      tracking_frame: "base_link"
      publish_odom_tf: true
      enable_occupancy_map: true
      occupancy_map_resolution: 0.05  # meters per cell
      occupancy_map_size: [20.0, 20.0]  # width, height in meters

  object_detection:
    package: "isaac_ros_detectnet"
    model: "ssd_mobilenet_v2_isaac"
    threshold: 0.5
    input_topic: "/camera/rgb/image_raw"
    output_topic: "/detections"
    engine_cache_path: "/tmp/detectnet.plan"
    input_tensor: "input_tensor"
    input_layer_width: 300
    input_layer_height: 300
    output_layer_names: ["scores", "boxes", "classes"]

  point_cloud:
    package: "isaac_ros_point_cloud_utils"
    parameters:
      input_topic: "/depth/image_raw"
      output_topic: "/point_cloud"
      camera_info_topic: "/camera/depth/camera_info"
      queue_size: 1

# Isaac Navigation Stack Configuration
navigation_stack:
  bt_navigator:
    ros__parameters:
      use_sim_time: false
      global_frame: map
      robot_base_frame: base_link
      odom_topic: /odom
      bt_loop_duration: 10
      default_server_timeout: 20
      enable_groot_monitoring: true
      groot_zmq_publisher_port: 1666
      groot_zmq_server_port: 1667
      # Bipedal-specific navigation parameters
      max_linear_speed: 0.3
      max_angular_speed: 0.5
      balance_threshold: 0.1

  controller_server:
    ros__parameters:
      use_sim_time: false
      controller_frequency: 20.0
      min_x_velocity_threshold: 0.001
      min_y_velocity_threshold: 0.5
      min_theta_velocity_threshold: 0.001
      progress_checker_plugin: "progress_checker"
      goal_checker_plugin: "goal_checker"
      controller_plugins: ["FollowPath"]

      FollowPath:
        plugin: "nav2_mppi_controller::MPPIController"
        time_steps: 50
        model_dt: 0.05
        batch_size: 1000
        vx_std: 0.2
        vy_std: 0.05
        wz_std: 0.3
        vx_max: 0.3  # Conservative for bipedal stability
        vx_min: -0.1
        vy_max: 0.1
        wz_max: 0.3
        xy_goal_tolerance: 0.1
        yaw_goal_tolerance: 0.1
        motion_model: "DiffDrive"
        # Bipedal-specific cost parameters
        balance_cost_weight: 10.0
        step_cost_weight: 5.0
        smoothness_cost_weight: 2.0

  planner_server:
    ros__parameters:
      expected_planner_frequency: 20.0
      planner_plugins: ["GridBased"]
      GridBased:
        plugin: "nav2_navfn_planner::NavfnPlanner"
        tolerance: 0.5
        use_astar: false
        allow_unknown: true

  recovery_server:
    ros__parameters:
      recovery_plugins: ["spin", "backup", "wait"]
      spin:
        plugin: "nav2_recoveries::Spin"
        spin_dist: 1.57
      backup:
        plugin: "nav2_recoveries::BackUp"
        backup_dist: 0.15
        backup_speed: 0.025
      wait:
        plugin: "nav2_recoveries::Wait"
        wait_duration: 1.0

  local_costmap:
    local_costmap:
      ros__parameters:
        update_frequency: 5.0
        publish_frequency: 2.0
        global_frame: odom
        robot_base_frame: base_link
        use_sim_time: false
        rolling_window: true
        width: 6
        height: 6
        resolution: 0.05  # Higher resolution for footstep planning
        robot_radius: 0.3
        # Bipedal-specific inflation
        inflation_radius: 0.5
        cost_scaling_factor: 3.0
        plugins: ["obstacle_layer", "inflation_layer"]
        obstacle_layer:
          plugin: "nav2_costmap_2d::ObstacleLayer"
          enabled: true
          observation_sources: scan
          scan:
            topic: /scan
            max_obstacle_height: 2.0
            clearing: true
            marking: true
            data_type: "LaserScan"
            raytrace_max_range: 3.0
            raytrace_min_range: 0.0
            obstacle_max_range: 2.5
            obstacle_min_range: 0.0

  global_costmap:
    global_costmap:
      ros__parameters:
        update_frequency: 1.0
        publish_frequency: 1.0
        global_frame: map
        robot_base_frame: base_link
        use_sim_time: false
        robot_radius: 0.3
        resolution: 0.1
        track_unknown_space: true
        plugins: ["obstacle_layer", "inflation_layer"]

# Isaac Learning and AI Configuration
learning_framework:
  reinforcement_learning:
    environment:
      num_envs: 4096
      env_spacing: 5.0
      episode_length: 1000
      asset_root: "/path/to/humanoid/assets"
      asset_file: "humanoid.urdf"
      obs_size: 48  # Observation space size
      action_size: 12  # Action space size (joint commands)

    training:
      algorithm: "PPO"
      learning_rate: 3.0e-4
      batch_size: 16384
      mini_batch_size: 4096
      num_epochs: 10
      gamma: 0.99
      lam: 0.95
      epsilon: 0.2
      max_iterations: 10000

    neural_network:
      architecture: "ActorCritic"
      activation: "ReLU"
      hidden_layers: [512, 256, 128]
      output_activation: "Tanh"

  domain_randomization:
    enabled: true
    parameters:
      mass_range: [0.8, 1.2]
      friction_range: [0.5, 1.5]
      com_offset_range: [-0.05, 0.05]
      actuator_delay_range: [0.0, 0.02]
      sensor_noise_range: [0.0, 0.01]
      gravity_range: [9.7, 9.9]

# Isaac TensorRT Optimization Configuration
tensorrt_optimization:
  inference:
    precision: "FP16"  # or "FP32" or "INT8"
    max_batch_size: 16
    workspace_size: 2147483648  # 2GB in bytes
    minimum_segment_size: 3
    calibration_dataset_size: 1000
    calibration_batch_size: 16

  models:
    visual_slam:
      enabled: true
      precision: "FP16"
      max_batch_size: 8
    object_detection:
      enabled: true
      precision: "FP16"
      max_batch_size: 16
    depth_estimation:
      enabled: true
      precision: "FP16"
      max_batch_size: 8

# Isaac Hardware Configuration
hardware:
  gpu:
    device_id: 0
    memory_fraction: 0.9
    allow_growth: true

  sensors:
    camera:
      width: 640
      height: 480
      fps: 30
      format: "bgr8"
      distortion_model: "plumb_bob"

    imu:
      rate: 100
      linear_acceleration_noise_density: 0.01
      angular_velocity_noise_density: 0.0001
      linear_acceleration_random_walk: 0.01
      angular_velocity_random_walk: 0.0001

    lidar:
      range_min: 0.1
      range_max: 25.0
      resolution: 0.01
      update_rate: 10

# Isaac Safety and Monitoring Configuration
safety:
  emergency_stop:
    enabled: true
    timeout: 5.0
    velocity_threshold: 0.5

  balance_monitoring:
    enabled: true
    com_threshold: 0.2  # meters from support polygon
    orientation_threshold: 0.5  # radians

  joint_limits:
    position_safety_factor: 0.95
    velocity_safety_factor: 0.90
    effort_safety_factor: 0.90

monitoring:
  performance:
    log_frequency: 10.0
    publish_diagnostics: true
    cpu_monitoring: true
    memory_monitoring: true
    gpu_monitoring: true

  diagnostics:
    enabled: true
    diagnostic_period: 1.0
    hardware_monitoring: true
    sensor_monitoring: true
    actuator_monitoring: true